// Generated by CoffeeScript 1.3.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['underscore', 'backbone', 'util/util'], function(_, Backbone, Util) {
    var FourSquareLocation;
    FourSquareLocation = (function(_super) {
      var funzioLoc;

      __extends(FourSquareLocation, _super);

      function FourSquareLocation() {
        return FourSquareLocation.__super__.constructor.apply(this, arguments);
      }

      FourSquareLocation.prototype.client_id = "JRCYYUZK5Q2GENAPUH2CNW2SG1RNVVBDDTADCOB1BWPQVUFK";

      FourSquareLocation.prototype.client_secret = "JKQOKQ2SVHVMO5VOOZQAFG55ZG2Y14EUPL44510SEZZUYMJH";

      FourSquareLocation.prototype.v = "20120426";

      FourSquareLocation.prototype.urlRoot = "https://api.foursquare.com/v2/venues/search";

      FourSquareLocation.prototype.countryCityMap = {
        "China": "Beijing",
        "Japan": "Tokyo",
        "United States": "CB, SF",
        "Argentina": "Buenos Aires"
      };

      FourSquareLocation.prototype.countryAbbrs = {
        "Argentina": "ARG",
        "China": "CN",
        "Japan": "JP",
        "United States": "US"
      };

      funzioLoc = {
        latitude: 37.7882888570246,
        longitude: -122.39682522210278
      };

      FourSquareLocation.prototype.url = function() {
        return "" + this.urlRoot + "?ll=" + (this.get('latitude')) + "," + (this.get('longitude')) + "&client_id=" + this.client_id + "&client_secret=" + this.client_secret + "&v=" + this.v;
      };

      FourSquareLocation.prototype.initialize = function() {
        _.bindAll(this);
        this.id = "foursquare_location";
        return this.localStorage = new Backbone.LocalStorage(this.id);
      };

      FourSquareLocation.prototype.locate = function() {
        this.trigger("locating");
        return navigator.geolocation.getCurrentPosition(this.getLocationSuccess, this.getLocationFail, {
          maximumAge: 60000
        });
      };

      FourSquareLocation.prototype.getLocationSuccess = function(position) {
        var currentLatitude, currentLongitude, newLatitude, newLongitude, promise;
        newLatitude = position.coords.latitude;
        newLongitude = position.coords.longitude;
        this.fetch();
        currentLatitude = this.get('latitude');
        currentLongitude = this.get('longitude');
        if (currentLatitude === void 0 || currentLongitude === void 0 || Math.abs(currentLatitude - newLatitude) > 0.01 || Math.abs(currentLongitude - newLongitude) > 0.01) {
          this.set(position.coords);
          promise = this.load();
          promise.done(this.parseResponse);
          return promise.fail(this.fetchLocationFromFourSquareFail);
        }
      };

      FourSquareLocation.prototype.getLocationFail = function() {
        return this.trigger('setLocation:failed');
      };

      FourSquareLocation.prototype.fetchLocationFromFourSquareFail = function() {
        return this.trigger("getLocationName:failed");
      };

      FourSquareLocation.prototype._parseCity = function(country) {
        if (country === "United States" && funzioLoc.latitude - this.get('latitude') <= 0.005) {
          return "2nd St., SF";
        } else {
          return this.countryCityMap[country];
        }
      };

      FourSquareLocation.prototype.parseResponse = function(resp) {
        var location;
        Util.debug("4sq response", resp);
        if (resp.meta.code !== 200) {
          this.trigger("getLocationName:failed");
          return;
        }
        location = resp.response.venues[0].location;
        this.set({
          country: location.country,
          city: this._parseCity(location.country),
          countryAbbr: this.countryAbbrs[location.country]
        });
        return this.save();
      };

      FourSquareLocation.prototype.load = function() {
        return $.ajax({
          dataType: "jsonp",
          url: this.url()
        });
      };

      return FourSquareLocation;

    })(Backbone.Model);
    return FourSquareLocation;
  });

}).call(this);
